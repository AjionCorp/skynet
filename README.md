# Skynet

AI-powered development pipeline. Uses Claude Code as the coding agent, bash scripts as workers, markdown files as state, and a Next.js dashboard for monitoring.

Drop it into any project. Configure it. Let it build.

## Architecture

```
LaunchAgents (macOS)
  └── watchdog (every 3m)
        ├── dev-worker-1    Pick task → branch → Claude Code → typecheck → test → merge
        ├── dev-worker-2    (parallel worker)
        ├── task-fixer      Retry failed tasks (up to 3 attempts)
        └── project-driver  Generate and prioritize backlog via Claude

  └── ui-tester (every 1h)         Playwright smoke tests
  └── feature-validator (every 2h) Deep feature tests
  └── health-check (daily 8am)     Typecheck + lint + auto-fix
  └── sync-runner (every 6h)       Hit API sync endpoints
  └── auth-refresh (every 30m)     Claude Code OAuth token refresh
```

**State files** (`.dev/`): `backlog.md`, `current-task.md`, `completed.md`, `failed-tasks.md`, `blockers.md`, `sync-health.md`

**Lock files** (`/tmp/`): PID-based worker locks, backlog mutex, token cache

## Quick Start

```bash
# 1. Clone into your tooling
git clone https://github.com/AjionCorp/skynet.git

# 2. Initialize in your project
cd /path/to/your/project
npx skynet init

# 3. Edit your project config
vi .dev/skynet.project.sh    # Add your project vision, conventions, sync endpoints

# 4. Install LaunchAgents (macOS)
npx skynet setup-agents

# 5. Or run manually
bash .dev/scripts/watchdog.sh
```

## Configuration

### `skynet.config.sh` (machine-specific, gitignored)

Generated by `skynet init`. Contains paths, secrets, and tuning knobs:

```bash
SKYNET_PROJECT_NAME="myproject"
SKYNET_PROJECT_DIR="/Users/me/myproject"
SKYNET_DEV_SERVER_CMD="pnpm dev"
SKYNET_TYPECHECK_CMD="pnpm typecheck"
SKYNET_TG_BOT_TOKEN="..."          # Telegram notifications (optional)
SKYNET_MAX_WORKERS=2                # Parallel dev workers
SKYNET_STALE_MINUTES=45             # Auto-fail stuck tasks after N minutes
```

### `skynet.project.sh` (project-specific, committable)

Your project's domain knowledge for the AI agents:

```bash
SKYNET_WORKER_CONTEXT="
# Your project conventions, data inventory, debugging tips
"

SKYNET_PROJECT_VISION="
# Your project mission — the project-driver uses this to generate tasks
"

SKYNET_SYNC_ENDPOINTS=("congress|/api/sync/congress" "economics|/api/sync/economics")
SKYNET_TASK_TAGS="FEAT FIX DATA INFRA TEST"
```

## Dashboard (Next.js)

Install the dashboard package in your Next.js app:

```bash
pnpm add @ajioncorp/skynet
```

### Mount API routes

```typescript
// app/api/admin/pipeline/status/route.ts
import { createPipelineStatusHandler } from "@ajioncorp/skynet/handlers";
import { createConfig } from "@ajioncorp/skynet";

const config = createConfig({
  projectName: "myproject",
  devDir: process.cwd() + "/.dev",
  lockPrefix: "/tmp/skynet-myproject",
});

export const GET = createPipelineStatusHandler(config);
```

### Mount dashboard pages

```tsx
// app/admin/pipeline/page.tsx
import { PipelineDashboard } from "@ajioncorp/skynet";

export default function Page() {
  return <PipelineDashboard />;
}
```

### Available components

| Component | Description |
|-----------|-------------|
| `PipelineDashboard` | Worker status, triggers, logs, backlog, completed, failed |
| `MonitoringDashboard` | Full 5-tab monitoring (overview, workers, tasks, logs, system) |
| `TasksDashboard` | Backlog management with create-task form |
| `SyncDashboard` | Data sync health overview |
| `AdminLayout` | Reusable admin layout with nav tabs |
| `SkynetProvider` | Context provider for custom API path prefix |

### Available handler factories

| Handler | Method | Description |
|---------|--------|-------------|
| `createPipelineStatusHandler` | GET | Full pipeline state (workers, backlog, tasks, sync) |
| `createPipelineTriggerHandler` | POST | Trigger a worker script |
| `createPipelineLogsHandler` | GET | Read worker log files |
| `createMonitoringStatusHandler` | GET | Extended status with git, auth, post-commit |
| `createMonitoringAgentsHandler` | GET | LaunchAgent status |
| `createMonitoringLogsHandler` | GET | Logs with search support |
| `createTasksHandlers` | GET/POST | Read backlog + create tasks |

## CLI Commands

```bash
skynet init              # Scaffold .dev/ directory and config files
skynet setup-agents      # Generate and install macOS LaunchAgents
skynet status            # Quick terminal status check
```

## Workers

| Worker | Schedule | What it does |
|--------|----------|-------------|
| **Dev Worker** | On demand (via watchdog) | Picks a task from backlog, creates a branch, invokes Claude Code, runs typecheck + Playwright tests, merges on success |
| **Task Fixer** | Every 30m | Retries failed tasks with error context, up to 3 attempts |
| **Project Driver** | 8am + 8pm | Analyzes project vision vs completed work, generates and prioritizes new backlog items |
| **Watchdog** | Every 3m | Dispatches idle workers when there's work to do |
| **UI Tester** | Every 1h | Runs Playwright smoke tests, auto-creates fix tasks on failure |
| **Feature Validator** | Every 2h | Deep Playwright feature tests |
| **Health Check** | Daily 8am | Typecheck + lint with Claude auto-fix loop |
| **Sync Runner** | Every 6h | Hits configured API sync endpoints |
| **Auth Refresh** | Every 30m | Refreshes Claude Code OAuth token from macOS Keychain |

## Project Structure

```
skynet/
├── scripts/              # Bash workers (the pipeline engine)
├── templates/            # Scaffolded into consumer projects by `skynet init`
│   └── launchagents/     # macOS LaunchAgent plist templates
├── packages/
│   ├── dashboard/        # @ajioncorp/skynet — React components + API handlers
│   └── cli/              # @ajioncorp/skynet-cli — init, setup-agents, status
```

## Requirements

- macOS (for LaunchAgents and Keychain auth)
- Node.js 18+
- Claude Code CLI (`claude`)
- pnpm (or configure `SKYNET_DEV_SERVER_CMD` etc. for npm/yarn)
- Playwright (optional, for test workers)

## License

MIT
