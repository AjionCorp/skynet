# Backlog

<!-- Priority: top = highest. Format: - [ ] [TAG] Task title — description -->
<!-- Markers: [ ] = pending, [>] = claimed by worker, [x] = done -->

- [x] [FIX] Inject previous failure context into task-fixer retry prompts — in scripts/task-fixer.sh, when building the Claude Code prompt for a retry, read the last 100 lines of the failed branch's worker log (`$SCRIPTS_DIR/dev-worker-*.log`) and include the error output in the prompt under a "## Previous Failure" section. Also include the git diff of what was changed on the failed branch (`git diff main...$BRANCH`). This gives Claude maximum context to fix the issue on retry, directly improving the self-correction success rate
- [x] [FIX] Fix watchdog hardcoded worker IDs breaking scaling beyond 2 workers — in scripts/watchdog.sh, the crash recovery (Phase 1 zombie detection) and heartbeat staleness loops use `for wid in 1 2` instead of `for wid in $(seq 1 "${SKYNET_MAX_WORKERS:-2}")`. If SKYNET_MAX_WORKERS is set to 3+, worker 3's stale heartbeats, orphaned claims, and zombie locks will never be detected. Fix all `for wid in 1 2` loops to use `seq 1 "$SKYNET_MAX_WORKERS"`. Also fix `validate_backlog()` in `_config.sh` which has the same issue _(merge failed)_
- [x] [FIX] Fix task-fixer reading only dev-worker-1.log regardless of which worker failed — in scripts/task-fixer.sh, the retry prompt context reads `tail -100 "$SCRIPTS_DIR/dev-worker-1.log"` hardcoded. When a task fails on worker 2, the fixer gets irrelevant log context, reducing fix success rate. Fix: parse the failed-tasks.md entry to determine which worker originally ran the task (match branch name against current-task-N.md files or check the log files for the task title), then read the correct worker's log
- [x] [FEAT] Add `skynet logs` CLI command — create packages/cli/src/commands/logs.ts. Accept subcommand for log type: `skynet logs worker [--id N]` (reads .dev/scripts/dev-worker-N.log), `skynet logs fixer`, `skynet logs watchdog`, `skynet logs health-check`. Support `--tail N` (default 50 lines) and `--follow` (uses `fs.watch` + readline to stream new lines). If no subcommand given, list available log files with their sizes and last-modified times. Register in packages/cli/src/index.ts
- [x] [FEAT] Add `skynet add-task` CLI command — create packages/cli/src/commands/add-task.ts. Usage: `skynet add-task "Task title" --tag FEAT --description "details" --position top`. Read .dev/backlog.md, find the insertion point (after the header comments, before first `[x]` entry for position=top, or before the `[x]` block for position=bottom). Write the new line as `- [ ] [TAG] Title — description`. Use atomic write (write to .tmp then rename). Register in packages/cli/src/index.ts
- [x] [FEAT] Add notification channel plugin system — refactor scripts/_notify.sh to support pluggable channels. Create scripts/notify/ directory with telegram.sh (move existing tg() function), slack.sh (POST to SKYNET_SLACK_WEBHOOK_URL with JSON payload), and discord.sh (POST to SKYNET_DISCORD_WEBHOOK_URL). Update _notify.sh to source all scripts/notify/*.sh files. Add SKYNET_NOTIFY_CHANNELS="telegram" to skynet.config.sh (comma-separated list). Update the `tg()` wrapper to call all enabled channels
- [x] [FEAT] Add pipeline health score to dashboard and `skynet status` — create a `calculate_health_score()` function. Formula: start at 100, subtract 5 per pending failed task, subtract 10 per active blocker, subtract 2 per stale heartbeat, subtract 1 per task pending >24h. Clamp to 0-100. Add to packages/dashboard/src/handlers/pipeline-status.ts response as `healthScore: number`. Display as a colored badge in PipelineDashboard component (green >80, yellow >50, red <=50). Also output in packages/cli/src/commands/status.ts
- [x] [FEAT] Add `skynet dashboard` CLI command to launch admin app — create packages/cli/src/commands/dashboard.ts. Resolve admin package path relative to skynet root (same pattern as init.ts). Run `pnpm --filter admin dev -- --port <PORT>` via child_process.spawn with stdio inherit. Default port 3100 (configurable via --port flag). Open browser automatically via `open` (macOS) or `xdg-open` (Linux). Register in packages/cli/src/index.ts
- [x] [INFRA] Add `npx skynet init` end-to-end smoke test — create tests/e2e/init-smoke.test.sh. Steps: (1) run `npm pack` in packages/cli, (2) create temp directory, init git repo, (3) install the tarball via npm, (4) run `npx skynet init --name test-project --dir $TMPDIR` non-interactively, (5) verify .dev/ directory created with all expected files (skynet.config.sh, backlog.md, mission.md, etc.), (6) verify scripts symlinked correctly, (7) cleanup. Add `"test:e2e:cli": "bash tests/e2e/init-smoke.test.sh"` to root package.json
- [x] [FEAT] Add multi-project PID isolation validation — in scripts/_config.sh, verify that SKYNET_LOCK_PREFIX includes the project name to prevent cross-project lock collisions. Add a check at startup: if any lock file exists at the prefix but belongs to a different SKYNET_PROJECT_DIR (by reading the lock's pid and checking its cwd via `lsof -p PID` or `/proc/PID/cwd`), log a warning. This ensures two skynet instances for different projects never interfere _(merge failed)_
- [x] [INFRA] Delete stale dev branches and prune worktrees — there are 12 orphaned dev/* branches from failed tasks that need cleanup. In scripts/watchdog.sh, add a `cleanup_stale_branches()` function that runs weekly (check a timestamp file `.dev/last-branch-cleanup`). For each local dev/* branch, check if it has been merged to main OR if its corresponding failed-tasks.md entry has status=fixed. If so, delete the branch via `git branch -D` and run `git worktree prune`. Log all actions _(merge failed)_
- [x] [FEAT] Add `skynet reset-task` CLI command — create packages/cli/src/commands/reset-task.ts. Usage: `skynet reset-task "task title substring"`. Searches failed-tasks.md for a matching entry, resets its status to pending and attempts to 0, finds the corresponding `[x]` entry in backlog.md and changes it back to `[ ]`. If the failed branch still exists, offers to delete it (with --force flag to skip confirmation). Register in packages/cli/src/index.ts
- [>] [FEAT] Add worker activity log rotation — in scripts/dev-worker.sh and task-fixer.sh, before starting a new task cycle, check if the log file exceeds 1MB. If so, rotate: rename current log to `$LOG.1`, remove `$LOG.2` if it exists (keep max 2 rotations). This prevents log files from growing unbounded during long pipeline runs. Add SKYNET_MAX_LOG_SIZE_KB=1024 to skynet.config.sh
- [>] [TEST] Add vitest unit tests for dashboard health score and task parsing — create packages/dashboard/src/handlers/pipeline-status.health.test.ts. Test: health score calculation with various inputs (no failures=100, max failures=0, mixed), backlog item parsing with blockedBy metadata, completed.md duration parsing, failed task status categorization. Aim for 10+ test cases covering edge cases
- [x] [FEAT] Add `skynet version` CLI command with update check — create packages/cli/src/commands/version.ts. Read version from package.json, display it. Optionally check npm registry for latest version of @ajioncorp/skynet-cli via `npm view` (with timeout, non-blocking on failure). If outdated, suggest update command. Register in packages/cli/src/index.ts
- [x] [FIX] Fix CLI scripts path resolution for npm package distribution — packages/cli/src/commands/init.ts line 7 resolves SKYNET_ROOT via `resolve(__dirname, "../../../..")` which only works inside the monorepo. When installed from npm, scripts/ won't be at that path. Fix: add `"files": ["dist", "scripts"]` to packages/cli/package.json so scripts ship with the tarball, then change SKYNET_ROOT resolution to use `fileURLToPath(new URL('../../scripts', import.meta.url))` pattern (relative to the compiled dist/commands/init.js). Verify `npm pack` includes scripts/ and that init.ts can locate them. Also add `"prepublishOnly": "tsc"` to packages/cli/package.json
- [x] [FIX] Add PID lock to health-check.sh to prevent concurrent instances — health-check.sh has no PID lock, so overlapping launchd/cron runs could invoke Claude simultaneously. Add `LOCK_FILE="$SCRIPTS_DIR/health-check.lock"`, acquire via `mkdir "$LOCK_FILE"` at script start with stale detection (same pattern as dev-worker.sh lines ~50-70), release in an EXIT trap. This aligns with the robustness standard set by dev-worker.sh and task-fixer.sh
- [x] [FIX] Harden task-fixer.sh EXIT trap for mid-merge crash safety — current EXIT trap in task-fixer.sh is minimal. If the script crashes during `git merge` or `git push`, the task remains claimed and the branch is orphaned. Add a full `cleanup_on_exit` function (matching dev-worker.sh pattern): unclaim task in backlog.md via `unclaim_task()`, remove worktree via `git worktree remove --force`, release PID lock, stop any background processes, and log the crash event
- [x] [FEAT] Add `skynet doctor` CLI diagnostics command — create packages/cli/src/commands/doctor.ts. Check: (1) required tools exist: git, node, pnpm, shellcheck — show version or MISSING, (2) skynet.config.sh exists and is parseable, (3) scripts/ directory is accessible and contains expected files (dev-worker.sh, watchdog.sh, etc.), (4) agent availability: run `claude --version` and `codex --version`, report which are available, (5) .dev/ state files exist (backlog.md, completed.md, etc.), (6) worker PID lock files — show active/stale status, (7) git repo status — clean/dirty, current branch. Output a summary with PASS/WARN/FAIL per check. Register in packages/cli/src/index.ts
- [x] [FEAT] Add `skynet add-task` CLI command for backlog injection _(merge failed — recreated above)_
- [x] [FEAT] Add worker port offset to prevent dev-server conflicts in multi-worker mode — in dev-worker.sh, when starting the dev server (start-dev.sh or SKYNET_START_DEV_CMD), pass a port offset based on WORKER_ID. Calculate: `WORKER_PORT=$((SKYNET_DEV_PORT + WORKER_ID - 1))`. Export as PORT env var before launching. Add SKYNET_DEV_PORT to skynet.config.sh (default: 3000). This prevents port collisions when workers 1 and 2 run simultaneously
- [x] [FEAT] Add Linux cron support to monitoring agents dashboard _(merge failed — functionality needed, retry via task-fixer)_
- [x] [FEAT] Add dynamic worker scaling from admin dashboard — add a "Scale Workers" section to the admin monitoring page with +/- buttons per worker type (dev-worker, task-fixer, project-driver). Backend: create POST /api/admin/workers/scale handler in packages/dashboard/src/handlers/ that accepts `{ workerType, count }`, spawns or kills worker processes by invoking the corresponding script via `child_process.spawn()` with proper PID tracking. Frontend: add WorkerScaling component showing current active count per type with increment/decrement controls. Must handle: PID file cleanup on scale-down, heartbeat registration on scale-up, max worker limit from config
- [x] [FEAT] Add backlog health validation to watchdog — add a `validate_backlog()` function in scripts/_config.sh that checks: (1) no duplicate task titles in pending items, (2) no orphaned `[>]` (claimed) entries without a matching active worker in current-task-N.md files, (3) `blockedBy` references point to tasks that actually exist in backlog or completed. Call from watchdog.sh on each run. Log warnings for any issues found, auto-fix orphaned claims by resetting to `[ ]`
- [x] [FEAT] Add task duration tracking to completed.md — in dev-worker.sh, record task start timestamp (already available as `$STARTED`) and compute duration when logging to completed.md. Add a Duration column to the completed.md table: `| Date | Task | Branch | Duration | Notes |`. Format as human-readable (e.g., "23m", "1h 12m"). Also update task-fixer.sh to track fix duration. Update the pipeline-status handler in packages/dashboard/src/handlers/pipeline-status.ts to parse and include average task duration in its response
- [x] [INFRA] Add root `test` script and CI unit test job — add `"test": "pnpm -r --filter '@ajioncorp/*' test"` to root package.json so `pnpm test` runs vitest in packages/dashboard (which already has 42 unit tests across 4 test files). Add a `unit-test` job to .github/workflows/ci.yml that runs `pnpm test` after install, alongside the existing typecheck and lint-sh jobs
- [x] [FEAT] Add automatic stale branch cleanup for abandoned failed tasks _(merge failed)_
- [x] [FEAT] Add configurable quality gates via skynet.config.sh — replace hardcoded typecheck+playwright gates in dev-worker.sh (lines ~140-180) and task-fixer.sh (lines ~165-220) with a SKYNET_GATES array. Add SKYNET_GATE_1="pnpm typecheck" etc. to skynet.config.sh. Loop through defined gates in both scripts. Default: just typecheck. This makes the pipeline generic for any project's CI needs
- [x] [FEAT] Add `skynet status` CLI command — create packages/cli/src/commands/status.ts that reads .dev/backlog.md, completed.md, failed-tasks.md, current-task.md, and worker PID lock files. Display: task counts by state, current task name+duration, worker PIDs and status, last activity timestamp, recent completions. Register in packages/cli/src/index.ts
- [x] [FEAT] we need to be able to see in admin for pipeline and monitoring who is active _(claude failed)_
- [x] [NMI] Lets have an ability to add more workers to different areas from the admin dynamically, say i want to increase the tester or fixer capacity or which ever i should be able to _(marked complete but no code was implemented — only .dev state files changed)_
- [x] [FEAT] Lets improve Pipeline and Monitoring for admin — some things are either dated or missing
- [x] [FEAT] Add worker heartbeat and stale detection — workers write a timestamp to .dev/worker-N.heartbeat every 60s during task execution (add periodic write in dev-worker.sh main implementation loop). watchdog.sh checks heartbeats on each run: if any heartbeat is older than SKYNET_STALE_MINUTES, kill the worker, unclaim its task in backlog.md, remove the worktree, reset current-task-N.md to idle
- [x] [FEAT] Add agent plugin system for LLM-agnostic workers — extract Claude Code and Codex CLI invocation from scripts/_config.sh run_agent() into separate plugins at scripts/agents/claude.sh and scripts/agents/codex.sh. Define standard interface: run_agent "prompt" "logfile" returns exit code. Add SKYNET_AGENT_PLUGIN config to skynet.config.sh. Allow custom agent scripts via file path
- [x] [INFRA] Add shellcheck linting for all shell scripts — add shellcheck as a dev dependency or document it as required tool, create `pnpm lint:sh` script that runs shellcheck on all scripts/*.sh files, fix reported issues (unquoted vars, missing error handling), integrate into the CI workflow
- [x] [TEST] Add integration test for full pipeline task lifecycle _(claude failed)_
- [x] [FEAT] Add `skynet logs` CLI command _(claude failed — recreated above with better spec)_
- [x] [TEST] Add Playwright tests for all dashboard component interactions _(claude failed)_
- [x] [INFRA] Add more tags and add tooltip to them _(claude failed)_
- [x] [FEAT] Add task dependency tracking — extend backlog.md syntax to support `blockedBy: task-title` metadata, update claim_next_task() in dev-worker.sh to skip tasks whose dependencies are not yet completed, add dependency visualization to dashboard tasks page
- [x] [FEAT] Add real-time pipeline dashboard via Server-Sent Events — create /api/admin/pipeline/stream route that watches .dev/ files for changes using fs.watch and streams status updates, update packages/admin/src/app/admin/pipeline/page.tsx to consume SSE instead of polling
- [x] [FEAT] Add crash recovery to watchdog _(playwright failed — retry pending, branch has implementation)_
- [x] [FEAT] Add `skynet start` and `skynet stop` CLI commands _(task-fixer retry in progress)_
- [x] [INFRA] Add npm package build and publish workflow _(playwright failed — retry pending, branch has implementation)_
- [x] [FEAT] Add self-correction metrics tracking _(playwright failed — retry pending, branch has implementation)_
- [x] [TEST] Add unit tests for shell script lock acquisition and task claiming _(playwright failed — retry pending, branch has implementation)_
- [x] [TEST] Add TypeScript tests for API handlers _(playwright failed — retry pending, branch has implementation)_
- [x] [FEAT] Add mission progress tracking to project-driver _(playwright failed — retry pending, branch has implementation)_
- [x] [FEAT] Add mission.md viewer tab to admin dashboard _(playwright failed — retry pending, branch has implementation)_
- [x] [INFRA] Add CI/CD workflow _(playwright failed — retry pending, branch has implementation)_
- [x] [FEAT] Add webhook notification support _(playwright failed — retry pending, branch has implementation)_
- [x] [INFRA] Add cron support alongside launchd _(playwright failed)_
