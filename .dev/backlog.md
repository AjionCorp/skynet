# Backlog

<!-- Priority: top = highest. Format: - [ ] [TAG] Task title — description -->
<!-- Markers: [ ] = pending, [>] = claimed by worker, [x] = done -->

- [x] [TEST] Add project-driver regression for active-root duplicate suppression counters — in `scripts/tests/project-driver.sh`, assert generation skips unchecked candidates when normalized roots are already active in `.dev/failed-tasks.md`, never skips unrelated roots, and emits deterministic `driver_duplicate_root_skipped` totals. Mission: Criterion #2 quality gates and Criterion #3 convergent planning.
- [x] [DATA] Refresh blockers Active from canonical failed roots after stale-active supersede — in `scripts/watchdog.sh` blockers sync path, rebuild `.dev/blockers.md` Active from normalized active failed roots only after the convergence pass and skip file rewrite when active-root hash is unchanged. Mission: Criterion #4 trustworthy visibility and Criterion #5 measurable progress.
- [>] [TEST] Add cross-surface parity regression for stale-active counters and root-hash fields — add/extend tests in `scripts/tests/watchdog.sh`, `packages/dashboard/src/handlers/pipeline-status.test.ts`, and CLI status tests to prove `staleActiveCompletedRows`, `supersededActiveRows`, and root-hash parity fields match semantics across watchdog, dashboard, and `status --json`. Mission: Criterion #2 quality gates and Criterion #4 telemetry trust.

- [>] [INFRA] Enforce active-root canonical row precedence (`fixing-*` > `blocked` > `pending`) in watchdog reconciliation — in `scripts/watchdog.sh`, when multiple active rows share a normalized root, deterministically keep the highest-priority status row (then latest row index tie-break), supersede lower-priority variants, and emit `canonicalization_precedence_applied` counters. Mission: Criterion #2 self-correction throughput and Criterion #3 deterministic recovery.
- [ ] [TEST] Add watchdog regression for active-root precedence and tie-break determinism — in `scripts/tests/watchdog.sh`, include fixtures where the same normalized root appears as `fixing-*`, `blocked`, and `pending`; assert canonical row selection follows precedence, unaffected rows are byte-identical, and second identical run is no-op. Mission: Criterion #2 quality gates and Criterion #3 convergent state.
- [ ] [INFRA] Compact duplicate non-active failed history rows before archive rotation — in `scripts/watchdog.sh`, collapse repeated `fixed|superseded` rows with the same normalized root+branch into one canonical history row before moving rows to `.dev/failed-tasks-archive.md`, preserving the newest attempts/error context and emitting deterministic `history_rows_compacted` metrics. Mission: Criterion #2 retry-loop throughput and Criterion #3 state convergence.
- [ ] [TEST] Add regression for failed-task history compaction invariants — in `scripts/tests/watchdog.sh`, assert compaction never touches active rows, preserves markdown table validity, is idempotent across two runs, and keeps archive parity checks stable. Mission: Criterion #2 quality gates and Criterion #3 deterministic state management.
- [ ] [DATA] Surface canonical active-root diagnostics in status JSON surfaces — extend `packages/dashboard/src/handlers/pipeline-status.ts` and `packages/cli/src/commands/status.ts` (`--json`) to include a bounded `activeRootDiagnostics` payload (`root`, `status`, `attempts`, `latestRow`) sourced from watchdog semantics so operators can verify one-row-per-root convergence quickly. Mission: Criterion #4 trustworthy visibility and Criterion #5 measurable progress.

# Recent checked history (last 30)
- [x] [INFRA] Close stale-active failed-root drift in one deterministic watchdog sweep — in `scripts/watchdog.sh`, run a canonical active-root convergence pass that supersedes only `status=blocked|pending` rows whose normalized root is already present in `.dev/completed.md`, preserves `fixing-*` rows byte-for-byte, and emits before/after counters plus one stable root-hash summary. Mission: Criterion #2 self-correction throughput and Criterion #3 convergent state.
- [x] [INFRA] Prevent project-driver from generating retry variants for active failed roots — in `scripts/project-driver.sh`, normalize unchecked candidate titles against active `pending|blocked|fixing-*` roots in `.dev/failed-tasks.md`, skip generation when a canonical root is already active, and log deterministic `driver_duplicate_root_skipped` counters. Mission: Criterion #2 retry-loop reduction and Criterion #3 durable root-cause planning.
- [x] [DATA] Surface stale-active convergence counters in status surfaces — add `staleActiveCompletedRows` and `supersededActiveRows` from watchdog reconciliation to `packages/dashboard/src/handlers/pipeline-status.ts` and CLI `status --json` output, keeping field semantics aligned. Mission: Criterion #4 trustworthy visibility and Criterion #5 measurable progress.
- [x] [TEST] Add watchdog regression for deterministic stale-active sweep evidence — in `scripts/tests/watchdog.sh`, add a fixture with mixed `blocked|pending|fixing-*` rows where only completed-root stale active rows are superseded, unaffected rows remain byte-identical, and emitted counters/hash summary are stable across two identical runs. Mission: Criterion #2 quality gates and Criterion #3 deterministic recovery. _(typecheck failed)_
- [x] [TEST] Add watchdog regression for stale blocked/pending supersede guardrails — in `scripts/tests/watchdog.sh`, assert completed-root supersede touches only stale `blocked|pending` rows, never rewrites `fixing-*` rows, and preserves unaffected active-row ordering byte-for-byte. Mission: Criterion #2 quality gates and Criterion #3 deterministic recovery. _(typecheck failed)_
- [x] [FIX] Harden failed-task table parsing for legacy unescaped pipe rows — in `scripts/_config.sh` parsing helpers and watchdog reconciliation reads, treat malformed pipe-expanded rows as recoverable (skip or normalize with explicit guard) instead of misclassifying status/attempt columns; emit deterministic skip logs with row index and preserve valid rows byte-for-byte. Mission: Criterion #3 deterministic state and Criterion #2 retry-loop stability.
- [x] [INFRA] Add watchdog preflight sanitizer for malformed failed-task rows before dispatch — add one idempotent pass in `scripts/watchdog.sh` that validates `.dev/failed-tasks.md` row column counts, repairs only known legacy corruption patterns from unescaped table pipes, and emits before/after counters (`rows_scanned`, `rows_repaired`, `rows_skipped`). Mission: Criterion #2 self-correction throughput and Criterion #3 convergent recovery state.
- [x] [INFRA] Enforce canonical backlog marker ordering in project-driver writes — in `scripts/project-driver.sh` backlog rewrite path, guarantee `[>]` rows remain first (byte-for-byte), `[ ]` rows follow, and top-level `[x]` rows are moved only into checked history section so active work is never buried by history noise. Mission: Criterion #3 deterministic planning state and Criterion #2 no-task-loss reliability.
- [x] [INFRA] Centralize failed-task markdown field codec into one shared shell path — in `scripts/_config.sh`, expose canonical encode/decode helpers for failed-task table fields (pipes, backticks, escaped newlines) and migrate `scripts/task-fixer.sh` plus `scripts/watchdog.sh` to exclusively use those helpers for all reads/writes. Mission: Criterion #3 deterministic state and Criterion #2 retry-loop stability.
- [x] [TEST] Add shell regression for failed-task field codec round-trip invariants — in shell tests for failed-task parsing/writes, feed adversarial task/error/branch strings through shared codec helpers and assert parse-stable round trips plus unchanged active-root counting semantics. Mission: Criterion #2 quality gates and Criterion #3 convergent parsing.
